name: Update Star Chart

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
  workflow_dispatch:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'

jobs:
  update-chart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Generate and update bar chart
        run: |
          python << 'EOF'
          import re
          from pathlib import Path

          # Read README
          readme_path = Path('README.md')
          readme_content = readme_path.read_text()

          # Extract star counts from badges
          # Pattern matches: Stars%20YYYY%20⭐-XX-yellow in markdown image URLs
          pattern = r'Stars%20(\d{4})%20⭐-(\d+)-yellow'
          matches = re.findall(pattern, readme_content)

          if not matches:
              print("No star badges found in README")
              exit(1)

          # Sort by year
          star_data = sorted([(int(year), int(stars)) for year, stars in matches])

          # Find max stars for scaling
          max_stars = max(stars for _, stars in star_data) if star_data else 1
          max_chart_width = 130  # Maximum total chart width in characters
          bar_width = max_chart_width - 15  # Reserve space for year label and star count (e.g., "2015: " and " 36")

          # Generate horizontal bar chart
          chart_lines = []
          chart_lines.append("### Star Progress Chart")
          chart_lines.append("")
          chart_lines.append("```")
          
          # Generate horizontal bars
          for year, stars in star_data:
              # Calculate bar length proportional to max stars
              bar_length = int((stars / max_stars) * bar_width) if max_stars > 0 else 0
              bar = "⭐" * bar_length
              # Format: "YYYY: [bar] stars"
              chart_lines.append(f"{year}: {bar} {stars}")
          
          chart_lines.append("```")
          chart_lines.append("")

          chart_text = '\n'.join(chart_lines)

          # Check if chart section already exists
          chart_marker = "### Star Progress Chart"
          
          if chart_marker in readme_content:
              # Replace existing chart section
              # Match from chart marker to end of code block (including newlines)
              pattern = rf'{re.escape(chart_marker)}.*?```\s*\n'
              readme_content = re.sub(
                  pattern,
                  chart_text + '\n',
                  readme_content,
                  flags=re.DOTALL
              )
          else:
              # Insert chart after badges
              lines = readme_content.split('\n')
              # Find the line after the last badge
              insert_pos = 0
              for i, line in enumerate(lines):
                  if 'Stars%20' in line and 'yellow' in line:
                      insert_pos = i + 1
              
              # Insert chart after badges
              lines.insert(insert_pos, chart_text)
              readme_content = '\n'.join(lines)

          # Write updated README
          readme_path.write_text(readme_content)
          print("Chart updated successfully!")
          print("\nGenerated chart:")
          print('\n'.join(chart_lines))
          EOF

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update star progress chart'
          file_pattern: README.md

