name: Update AoC Badges

on:
  push:
    branches:
      - main
    
  workflow_dispatch:                             # allow to manually start the workflow 
  
# push:                                          # (disabled) run on push, be carefull with this setting 
                                                 # as the workflow should only be triggered at a rate lower than
                                                 # 4 times a hour to keep traffic on aoc site low 
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Update badges for all years
        env:
          AOC_USER_ID: ${{ secrets.AOC_USER_ID }}
          AOC_SESSION: ${{ secrets.AOC_SESSION }}
        run: |
          # Find all directories that match a 4-digit year pattern (sorted)
          years=$(ls -d [0-9][0-9][0-9][0-9]/ 2>/dev/null | sed 's/\///' | sort)
          echo "Detected years: $years"
          
          # Collect all badges with updated star counts
          declare -a badges
          
          for year in $years; do
            echo "--- Fetching stats for $year ---"
            
            # Fetch stars from AoC API
            json_response=$(curl -s -b "session=$AOC_SESSION" "https://adventofcode.com/$year/leaderboard/private/view/$AOC_USER_ID.json" 2>/dev/null || echo "{}")
            
            if echo "$json_response" | jq -e '.members' > /dev/null 2>&1; then
              stars=$(echo "$json_response" | jq -r ".members.\"$AOC_USER_ID\".stars // 0")
            else
              # Fallback: parse from the self leaderboard page
              stars=$(curl -s -b "session=$AOC_SESSION" "https://adventofcode.com/$year/leaderboard/self" | grep -oP '\*</span>' | wc -l || echo "0")
            fi
            
            echo "Stars for $year: $stars"
            badges+=("![](https://img.shields.io/badge/Stars%20${year}%20⭐-${stars}-yellow)")
            
            # Small delay to be nice to AoC servers
            sleep 1
          done
          
          # Remove all existing badge lines from README
          sed -i '/img\.shields\.io\/badge\/Stars%20[0-9]*%20⭐/d' README.md
          
          # Find line number of </h1> to insert badges after
          h1_line=$(grep -n "</h1>" README.md | head -1 | cut -d: -f1)
          
          if [ -z "$h1_line" ]; then
            # Fallback: insert at line 1 if no </h1> found
            h1_line=1
          fi
          
          # Build the badge block with proper formatting
          badge_block=""
          for badge in "${badges[@]}"; do
            badge_block="${badge_block}${badge}"$'\n'
          done
          
          # Use awk to insert badges after </h1> with blank lines before and after
          awk -v h1="$h1_line" -v badges="$badge_block" '
            NR == h1 { print; print ""; printf "%s", badges; print ""; next }
            { print }
          ' README.md > README.tmp && mv README.tmp README.md
          
          echo "Updated README with ${#badges[@]} badges"

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update badges
          file_pattern: README.md
